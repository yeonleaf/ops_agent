<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê·¸ë£¹ ë³´ê³ ì„œ ìƒì„± - ì›”ê°„ë³´ê³  ìƒì„±ê¸°</title>
    <link rel="stylesheet" href="/static/app.css">
    <style>
        .report-settings {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .prompt-selector {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .category-section {
            margin-bottom: 30px;
        }

        .category-header {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .category-header:hover {
            background: #ececec;
        }

        .category-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .category-title {
            font-size: 1.1em;
            font-weight: 500;
            color: #2c3e50;
            flex: 1;
        }

        .category-count {
            color: #666;
            font-size: 0.9em;
        }

        .system-group {
            margin-left: 30px;
            margin-bottom: 15px;
            padding: 10px;
            background: #fafafa;
            border-left: 3px solid #4CAF50;
            border-radius: 4px;
        }

        .system-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .system-title {
            font-weight: 500;
            color: #34495e;
        }

        .prompt-item {
            margin-left: 30px;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .prompt-item:hover {
            background: #f9f9f9;
        }

        .prompt-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .prompt-info {
            flex: 1;
        }

        .prompt-title {
            color: #333;
            font-size: 0.95em;
        }

        .prompt-meta {
            color: #999;
            font-size: 0.85em;
            margin-top: 2px;
        }

        .actions-bar {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .selection-info {
            color: #666;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .preview {
            display: none;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .preview.active {
            display: block;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .preview-content {
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 8px;
            margin: 20px 0;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            display: none;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .message.active {
            display: block;
        }

        .message.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef5350;
        }

        .message.success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #66bb6a;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
    </style>
</head>
<body>
    <!-- í—¤ë” -->
    <header class="app-header">
        <div class="header-content">
            <h1>ğŸ“Š ê·¸ë£¹ ë³´ê³ ì„œ ìƒì„±</h1>
            <div class="user-info">
                <a href="#" onclick="goBack()" style="margin-right: 15px; color: white; text-decoration: none;">â† ê·¸ë£¹ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
                <span class="username" id="username"></span>
                <button class="btn-logout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </header>

    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div class="app-container">
        <!-- ë¡œë”© -->
        <div id="loading-init" class="loading" style="display: block;">
            <div class="spinner"></div>
            <p>í”„ë¡¬í”„íŠ¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>

        <!-- ë©”ì‹œì§€ -->
        <div id="message" class="message"></div>

        <!-- ë³´ê³ ì„œ ì„¤ì • -->
        <div id="report-settings" class="report-settings" style="display: none;">
            <h3>ë³´ê³ ì„œ ì„¤ì •</h3>
            <div class="form-group">
                <label for="report-title">ë³´ê³ ì„œ ì œëª©</label>
                <input type="text" id="report-title" placeholder="ì˜ˆ: ì›”ê°„ë³´ê³  (2025.10)" value="ì›”ê°„ë³´ê³ ">
            </div>
            <div style="display: flex; gap: 20px;">
                <label>
                    <input type="checkbox" id="include-toc" checked>
                    ëª©ì°¨ í¬í•¨
                </label>
                <label>
                    <input type="checkbox" id="save-report" checked>
                    íˆìŠ¤í† ë¦¬ ì €ì¥
                </label>
            </div>
        </div>

        <!-- í”„ë¡¬í”„íŠ¸ ì„ íƒ -->
        <div id="prompt-selector" class="prompt-selector" style="display: none;">
            <h3>í”„ë¡¬í”„íŠ¸ ì„ íƒ</h3>
            <p style="color: #666; margin-bottom: 20px;">ë³´ê³ ì„œì— í¬í•¨í•  í”„ë¡¬í”„íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”. ì„ íƒí•œ ìˆœì„œëŒ€ë¡œ ì¹´í…Œê³ ë¦¬ > ì‹œìŠ¤í…œë³„ë¡œ ì •ë ¬ë©ë‹ˆë‹¤.</p>

            <div id="categories-container">
                <!-- ë™ì  ìƒì„± -->
            </div>

            <div id="prompts-empty" class="empty-state" style="display: none;">
                <p>ì•„ì§ ì‘ì„±ëœ í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                <button class="btn btn-primary" onclick="goToGroupDetail()">ê·¸ë£¹ í˜ì´ì§€ë¡œ ì´ë™</button>
            </div>
        </div>

        <!-- ì•¡ì…˜ ë°” -->
        <div id="actions-bar" class="actions-bar" style="display: none;">
            <div class="selection-info">
                <span id="selected-count">0</span>ê°œ í”„ë¡¬í”„íŠ¸ ì„ íƒë¨
            </div>
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="selectAll()">ì „ì²´ ì„ íƒ</button>
                <button class="btn btn-secondary" onclick="deselectAll()">ì „ì²´ í•´ì œ</button>
                <button class="btn btn-primary" onclick="generateReport()">ğŸš€ ë³´ê³ ì„œ ìƒì„±</button>
            </div>
        </div>

        <!-- ìƒì„± ë¡œë”© -->
        <div id="loading-generate" class="loading">
            <div class="spinner"></div>
            <p>ê·¸ë£¹ ë³´ê³ ì„œë¥¼ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤... ì‹œê°„ì´ ë‹¤ì†Œ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>

        <!-- ë¯¸ë¦¬ë³´ê¸° -->
        <div id="preview" class="preview">
            <div class="preview-header">
                <h3>ğŸ“„ ìƒì„±ëœ ê·¸ë£¹ ë³´ê³ ì„œ</h3>
                <div>
                    <button class="btn btn-secondary" onclick="downloadReport()" style="margin-right: 10px;">ğŸ’¾ HTML ë‹¤ìš´ë¡œë“œ</button>
                    <button class="btn btn-primary" onclick="resetBuilder()">ğŸ”„ ìƒˆë¡œ ë§Œë“¤ê¸°</button>
                </div>
            </div>
            <div class="preview-content" id="preview-content"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v2';
        let token = localStorage.getItem('token');
        let groupId = null;
        let groupData = null;
        let allPrompts = [];
        let generatedHtml = null;

        // í˜ì´ì§€ ë¡œë“œ
        window.addEventListener('DOMContentLoaded', () => {
            if (!token) {
                window.location.href = '/static/login.html';
                return;
            }

            const params = new URLSearchParams(window.location.search);
            groupId = params.get('id');

            if (!groupId) {
                alert('ê·¸ë£¹ IDê°€ ì—†ìŠµë‹ˆë‹¤');
                window.location.href = '/static/groups.html';
                return;
            }

            loadUserInfo();
            loadGroupPrompts();
        });

        async function loadUserInfo() {
            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('username').textContent = data.username;
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        async function loadGroupPrompts() {
            try {
                const response = await fetch(`${API_BASE}/groups/${groupId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('ê·¸ë£¹ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨');
                }

                const data = await response.json();
                groupData = data.data;

                renderPromptTree();

                document.getElementById('loading-init').style.display = 'none';
                document.getElementById('report-settings').style.display = 'block';
                document.getElementById('prompt-selector').style.display = 'block';
                document.getElementById('actions-bar').style.display = 'flex';

            } catch (error) {
                showMessage('í”„ë¡¬í”„íŠ¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                document.getElementById('loading-init').style.display = 'none';
            }
        }

        function renderPromptTree() {
            const container = document.getElementById('categories-container');
            const emptyState = document.getElementById('prompts-empty');
            container.innerHTML = '';

            const promptsByCategory = groupData.prompts_by_category || {};
            const categories = Object.keys(promptsByCategory);

            if (categories.length === 0) {
                emptyState.style.display = 'block';
                return;
            }

            allPrompts = [];

            categories.forEach((category, catIndex) => {
                const prompts = promptsByCategory[category];
                const categorySection = document.createElement('div');
                categorySection.className = 'category-section';

                // ì¹´í…Œê³ ë¦¬ í—¤ë”
                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'category-header';
                categoryHeader.innerHTML = `
                    <input type="checkbox" class="category-checkbox" id="cat-${catIndex}" onchange="toggleCategory(${catIndex})">
                    <label for="cat-${catIndex}" class="category-title">${escapeHtml(category)}</label>
                    <span class="category-count">${prompts.length}ê°œ í”„ë¡¬í”„íŠ¸</span>
                `;
                categorySection.appendChild(categoryHeader);

                // ì‹œìŠ¤í…œë³„ë¡œ ê·¸ë£¹í•‘
                const promptsBySystem = {};
                prompts.forEach(prompt => {
                    const system = prompt.system || 'ê¸°íƒ€';
                    if (!promptsBySystem[system]) {
                        promptsBySystem[system] = [];
                    }
                    promptsBySystem[system].push(prompt);
                    allPrompts.push({ ...prompt, categoryIndex: catIndex, category });
                });

                // ì‹œìŠ¤í…œë³„ ì„¹ì…˜
                Object.keys(promptsBySystem).forEach((system, sysIndex) => {
                    const systemGroup = document.createElement('div');
                    systemGroup.className = 'system-group';

                    const systemHeader = document.createElement('div');
                    systemHeader.className = 'system-header';
                    systemHeader.innerHTML = `
                        <input type="checkbox" class="system-checkbox" id="sys-${catIndex}-${sysIndex}" onchange="toggleSystem(${catIndex}, ${sysIndex})">
                        <label for="sys-${catIndex}-${sysIndex}" class="system-title">${escapeHtml(system)}</label>
                        <span class="category-count">${promptsBySystem[system].length}ê°œ</span>
                    `;
                    systemGroup.appendChild(systemHeader);

                    // í”„ë¡¬í”„íŠ¸ ëª©ë¡
                    promptsBySystem[system].forEach(prompt => {
                        const promptItem = document.createElement('div');
                        promptItem.className = 'prompt-item';
                        promptItem.innerHTML = `
                            <input type="checkbox" class="prompt-checkbox" id="prompt-${prompt.id}" data-prompt-id="${prompt.id}" onchange="updateSelectionCount()">
                            <label for="prompt-${prompt.id}" class="prompt-info">
                                <div class="prompt-title">${escapeHtml(prompt.title)}</div>
                                <div class="prompt-meta">ì‘ì„±ì: ${escapeHtml(prompt.owner || 'ì•Œ ìˆ˜ ì—†ìŒ')}</div>
                            </label>
                        `;
                        systemGroup.appendChild(promptItem);
                    });

                    categorySection.appendChild(systemGroup);
                });

                container.appendChild(categorySection);
            });

            updateSelectionCount();
        }

        function toggleCategory(catIndex) {
            const checkbox = document.getElementById(`cat-${catIndex}`);
            const checkboxes = document.querySelectorAll(`input[type="checkbox"][data-prompt-id]`);
            const categoryPrompts = allPrompts.filter(p => p.categoryIndex === catIndex);

            categoryPrompts.forEach(prompt => {
                const promptCheckbox = document.getElementById(`prompt-${prompt.id}`);
                if (promptCheckbox) {
                    promptCheckbox.checked = checkbox.checked;
                }
            });

            updateSelectionCount();
        }

        function toggleSystem(catIndex, sysIndex) {
            const checkbox = document.getElementById(`sys-${catIndex}-${sysIndex}`);
            const systemGroup = checkbox.closest('.system-group');
            const promptCheckboxes = systemGroup.querySelectorAll('.prompt-checkbox');

            promptCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });

            updateSelectionCount();
        }

        function selectAll() {
            document.querySelectorAll('.prompt-checkbox').forEach(cb => cb.checked = true);
            updateSelectionCount();
        }

        function deselectAll() {
            document.querySelectorAll('.prompt-checkbox').forEach(cb => cb.checked = false);
            updateSelectionCount();
        }

        function updateSelectionCount() {
            const count = document.querySelectorAll('.prompt-checkbox:checked').length;
            document.getElementById('selected-count').textContent = count;
        }

        async function generateReport() {
            const title = document.getElementById('report-title').value.trim();
            if (!title) {
                alert('ë³´ê³ ì„œ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            const selectedPrompts = [];
            document.querySelectorAll('.prompt-checkbox:checked').forEach(cb => {
                selectedPrompts.push(parseInt(cb.dataset.promptId));
            });

            if (selectedPrompts.length === 0) {
                alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ í”„ë¡¬í”„íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”');
                return;
            }

            const includeToc = document.getElementById('include-toc').checked;
            const save = document.getElementById('save-report').checked;

            document.getElementById('loading-generate').classList.add('active');
            document.getElementById('actions-bar').style.display = 'none';

            try {
                const response = await fetch(`${API_BASE}/groups/${groupId}/reports/generate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title,
                        prompt_ids: selectedPrompts,
                        include_toc: includeToc,
                        save
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'ë³´ê³ ì„œ ìƒì„± ì‹¤íŒ¨');
                }

                const data = await response.json();
                generatedHtml = data.html;

                document.getElementById('preview-content').innerHTML = generatedHtml;
                document.getElementById('preview').classList.add('active');
                showMessage('ê·¸ë£¹ ë³´ê³ ì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');

            } catch (error) {
                showMessage('ë³´ê³ ì„œ ìƒì„± ì‹¤íŒ¨: ' + error.message, 'error');
                document.getElementById('actions-bar').style.display = 'flex';
            } finally {
                document.getElementById('loading-generate').classList.remove('active');
            }
        }

        function downloadReport() {
            if (!generatedHtml) {
                alert('ìƒì„±ëœ ë³´ê³ ì„œê°€ ì—†ìŠµë‹ˆë‹¤');
                return;
            }

            const blob = new Blob([generatedHtml], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `group_report_${Date.now()}.html`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function resetBuilder() {
            document.getElementById('preview').classList.remove('active');
            document.getElementById('actions-bar').style.display = 'flex';
            generatedHtml = null;
            deselectAll();
        }

        function goBack() {
            window.location.href = `/static/group-detail.html?id=${groupId}`;
        }

        function goToGroupDetail() {
            window.location.href = `/static/group-detail.html?id=${groupId}`;
        }

        function showMessage(text, type = 'info') {
            const message = document.getElementById('message');
            message.textContent = text;
            message.className = `message active ${type}`;
            setTimeout(() => message.classList.remove('active'), 5000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/static/login.html';
        }
    </script>
</body>
</html>
